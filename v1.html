<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TT Loan Tracker</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #166088;
            --danger-color: #e74c3c;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --background-dark: rgba(30, 30, 40, 0.95);
            --background-light: rgba(40, 40, 50, 0.9);
            --border-color: rgba(100, 100, 150, 0.3);
            --text-color: #e0e0ff;
            --text-muted: #a0a0c0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
            color: var(--text-color);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: var(--background-dark);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: #fff;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
        }

        .subtitle {
            font-size: 1.2rem;
            color: var(--text-muted);
            margin-bottom: 20px;
        }

        .loan-window {
            background: var(--background-dark);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            min-height: 300px;
            transition: all 0.3s ease;
        }

        .loan-window:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
        }

        .window-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .window-title {
            font-size: 1.8rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .window-title i {
            color: var(--primary-color);
        }

        .loan-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--background-light);
            border-radius: 10px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 10px 0;
        }

        .loan .stat-value {
            color: var(--danger-color);
        }

        .paid .stat-value {
            color: var(--success-color);
        }

        .remaining .stat-value {
            color: var(--warning-color);
        }

        .stat-label {
            font-size: 1.1rem;
            color: var(--text-muted);
            margin-bottom: 5px;
        }

        .progress-container {
            margin: 30px 0;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .progress-bar {
            height: 25px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success-color), #27ae60);
            border-radius: 12px;
            transition: width 1s ease-in-out;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            color: white;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .progress-fill.low {
            background: linear-gradient(90deg, var(--danger-color), #c0392b);
        }

        .progress-fill.medium {
            background: linear-gradient(90deg, var(--warning-color), #d35400);
        }

        .api-form {
            background: var(--background-light);
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
        }

        .form-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        input, select {
            width: 100%;
            padding: 12px 15px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-color);
            font-size: 1rem;
            transition: border 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
            flex: 1;
        }

        .btn-primary:hover {
            background: var(--secondary-color);
            transform: translateY(-3px);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            border-radius: 8px;
            margin-top: 20px;
            background: rgba(0, 0, 0, 0.2);
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .status-dot.connected {
            background: var(--success-color);
            animation: pulse 2s infinite;
        }

        .status-dot.disconnected {
            background: var(--danger-color);
        }

        .status-dot.loading {
            background: var(--warning-color);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .loan-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        .detail-item {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 5px;
        }

        .detail-value {
            font-size: 1.2rem;
            font-weight: 600;
        }

        footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: var(--text-muted);
            font-size: 0.9rem;
            border-top: 1px solid var(--border-color);
            width: 100%;
        }

        .instructions {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .instructions h4 {
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .instructions ol {
            padding-left: 20px;
        }

        .instructions li {
            margin-bottom: 8px;
        }

        .server-selector {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .server-btn {
            padding: 8px 15px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-color);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .server-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .server-btn.active {
            background: var(--primary-color);
            border-color: var(--primary-color);
        }

        @media (max-width: 768px) {
            .loan-stats {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            h1 {
                font-size: 2rem;
            }
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-hand-holding-usd"></i> Transport Tycoon Loan Tracker</h1>
            <p class="subtitle">Monitor your loan status with full transparency - See exactly how much you've paid and how much you still owe</p>
        </header>

        <main class="loan-window">
            <div class="window-header">
                <div class="window-title">
                    <i class="fas fa-chart-line"></i>
                    <span>Loan Dashboard</span>
                </div>
                <div class="status-indicator" id="statusIndicator">
                    <div class="status-dot disconnected" id="statusDot"></div>
                    <span id="statusText">Not Connected</span>
                </div>
            </div>

            <div class="loan-stats">
                <div class="stat-card loan">
                    <div class="stat-label">Current Loan Balance</div>
                    <div class="stat-value" id="loanBalance">$0</div>
                    <div class="stat-desc">Amount you currently owe</div>
                </div>
                
                <div class="stat-card paid">
                    <div class="stat-label">Total Paid</div>
                    <div class="stat-value" id="totalPaid">$0</div>
                    <div class="stat-desc">Amount paid towards loan</div>
                </div>
                
                <div class="stat-card remaining">
                    <div class="stat-label">Remaining</div>
                    <div class="stat-value" id="remainingBalance">$0</div>
                    <div class="stat-desc">Original loan amount</div>
                </div>
            </div>

            <div class="progress-container">
                <div class="progress-header">
                    <span>Loan Repayment Progress</span>
                    <span id="progressPercentage">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
                </div>
            </div>

            <div class="loan-details" id="loanDetails">
                <div class="detail-item">
                    <div class="detail-label">Last Updated</div>
                    <div class="detail-value" id="lastUpdated">Never</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">API Charges Used</div>
                    <div class="detail-value" id="apiCharges">0</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Server</div>
                    <div class="detail-value" id="currentServer">Not Set</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Player Status</div>
                    <div class="detail-value" id="playerStatus">Offline</div>
                </div>
            </div>

            <div class="instructions">
                <h4><i class="fas fa-info-circle"></i> How to use:</h4>
                <ol>
                    <li>Get your private API key using <code>/api private new</code> in-game</li>
                    <li>Enter your vRP ID (found using <code>/id</code> in-game)</li>
                    <li>Select your server and click "Connect"</li>
                    <li>Loan data will update automatically every 60 seconds</li>
                </ol>
            </div>
        </main>

        <div class="api-form">
            <div class="form-title">
                <i class="fas fa-key"></i>
                <span>API Configuration</span>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="privateKey"><i class="fas fa-lock"></i> Private API Key *</label>
                    <input type="password" id="privateKey" placeholder="Enter your private API key">
                    <small>Get this with <code>/api private new</code> in-game</small>
                </div>
                
                <div class="form-group">
                    <label for="vRPid"><i class="fas fa-id-card"></i> vRP ID *</label>
                    <input type="number" id="vRPid" placeholder="Enter your vRP ID">
                    <small>Find with <code>/id</code> in-game</small>
                </div>
            </div>
            
            <div class="form-group">
                <label for="publicKey"><i class="fas fa-unlock"></i> Public API Key (Optional)</label>
                <input type="text" id="publicKey" placeholder="Enter public key if accessing another player's data">
                <small>Get with <code>/api public generate</code> (only needed for other players)</small>
            </div>
            
            <div class="form-group">
                <label><i class="fas fa-server"></i> Select Server</label>
                <div class="server-selector" id="serverSelector">
                    <!-- Server buttons will be added here dynamically -->
                </div>
                <small>Select the server where your player is currently online</small>
            </div>
            
            <div class="button-group">
                <button class="btn btn-primary" id="connectBtn">
                    <i class="fas fa-plug"></i> Connect to API
                </button>
                <button class="btn btn-secondary" id="refreshBtn">
                    <i class="fas fa-sync-alt"></i> Refresh Now
                </button>
                <button class="btn btn-secondary" id="saveBtn">
                    <i class="fas fa-save"></i> Save Settings
                </button>
                <button class="btn btn-danger" id="clearBtn">
                    <i class="fas fa-trash"></i> Clear All
                </button>
            </div>
            
            <div class="status-indicator hidden" id="apiStatus">
                <div class="status-dot loading"></div>
                <span id="apiStatusText">Connecting to API...</span>
            </div>
        </div>

        <footer>
            <p>Transport Tycoon Loan Tracker | Uses the official TT API | Data updates require player to be online</p>
            <p>API Documentation: <a href="https://docs.tycoon.community" style="color: var(--primary-color);">https://docs.tycoon.community</a></p>
        </footer>
    </div>

    <script>
        // Configuration
        const API_SERVERS = {
            'Server 1': 'https://tycoon-w8r4q4.users.cfx.re/',
            'Server 2': 'https://tycoon-2epova.users.cfx.re/',
            'Server 3': 'https://tycoon-2epovd.users.cfx.re/',
            'Server 4': 'https://tycoon-wdrypd.users.cfx.re/',
            'Server 5': 'https://tycoon-njyvop.users.cfx.re/',
            'Server 6': 'https://tycoon-2r4588.users.cfx.re/',
            'Server 7': 'https://tycoon-npl5oy.users.cfx.re/',
            'Server 8': 'https://tycoon-2vzlde.users.cfx.re/',
            'Server 9': 'https://tycoon-wmapod.users.cfx.re/',
            'Server A': 'https://tycoon-wxjpge.users.cfx.re/',
            '[LITE]': 'https://tycoon-dgpvx3.users.cfx.re/'
        };

        // State variables
        let currentServer = '';
        let privateKey = '';
        let vRPid = '';
        let publicKey = '';
        let apiInterval = null;
        let originalLoanAmount = 0; // This would need to be stored from first loan detection
        let totalPaid = 0;
        let lastLoanAmount = 0;

        // DOM Elements
        const connectBtn = document.getElementById('connectBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const saveBtn = document.getElementById('saveBtn');
        const clearBtn = document.getElementById('clearBtn');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const statusIndicator = document.getElementById('statusIndicator');
        const apiStatus = document.getElementById('apiStatus');
        const apiStatusText = document.getElementById('apiStatusText');
        const serverSelector = document.getElementById('serverSelector');

        // Initialize server selector
        function initServerSelector() {
            serverSelector.innerHTML = '';
            for (const [serverName, serverUrl] of Object.entries(API_SERVERS)) {
                const button = document.createElement('button');
                button.className = 'server-btn';
                button.textContent = serverName;
                button.dataset.url = serverUrl;
                button.addEventListener('click', () => selectServer(serverName, serverUrl));
                serverSelector.appendChild(button);
            }
        }

        // Select server
        function selectServer(serverName, serverUrl) {
            // Update UI
            document.querySelectorAll('.server-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            currentServer = serverUrl;
            document.getElementById('currentServer').textContent = serverName;
            
            // Save to localStorage
            localStorage.setItem('ttLoanTracker_server', serverName);
            localStorage.setItem('ttLoanTracker_serverUrl', serverUrl);
        }

        // Load saved settings
        function loadSettings() {
            const savedPrivateKey = localStorage.getItem('ttLoanTracker_privateKey');
            const savedVRPid = localStorage.getItem('ttLoanTracker_vRPid');
            const savedPublicKey = localStorage.getItem('ttLoanTracker_publicKey');
            const savedServer = localStorage.getItem('ttLoanTracker_server');
            const savedServerUrl = localStorage.getItem('ttLoanTracker_serverUrl');
            const savedOriginalLoan = localStorage.getItem('ttLoanTracker_originalLoan');
            const savedTotalPaid = localStorage.getItem('ttLoanTracker_totalPaid');
            const savedLastLoan = localStorage.getItem('ttLoanTracker_lastLoan');
            
            if (savedPrivateKey) {
                document.getElementById('privateKey').value = savedPrivateKey;
                privateKey = savedPrivateKey;
            }
            
            if (savedVRPid) {
                document.getElementById('vRPid').value = savedVRPid;
                vRPid = savedVRPid;
            }
            
            if (savedPublicKey) {
                document.getElementById('publicKey').value = savedPublicKey;
                publicKey = savedPublicKey;
            }
            
            if (savedServer && savedServerUrl) {
                currentServer = savedServerUrl;
                document.getElementById('currentServer').textContent = savedServer;
                
                // Activate the correct server button
                document.querySelectorAll('.server-btn').forEach(btn => {
                    if (btn.textContent === savedServer) {
                        btn.classList.add('active');
                    }
                });
            }
            
            if (savedOriginalLoan) {
                originalLoanAmount = parseFloat(savedOriginalLoan);
            }
            
            if (savedTotalPaid) {
                totalPaid = parseFloat(savedTotalPaid);
                updateTotalPaidDisplay();
            }
            
            if (savedLastLoan) {
                lastLoanAmount = parseFloat(savedLastLoan);
            }
            
            // If we have all required data, auto-connect
            if (privateKey && vRPid && currentServer) {
                setTimeout(() => {
                    connectBtn.click();
                }, 1000);
            }
        }

        // Save settings
        function saveSettings() {
            privateKey = document.getElementById('privateKey').value.trim();
            vRPid = document.getElementById('vRPid').value.trim();
            publicKey = document.getElementById('publicKey').value.trim();
            
            localStorage.setItem('ttLoanTracker_privateKey', privateKey);
            localStorage.setItem('ttLoanTracker_vRPid', vRPid);
            localStorage.setItem('ttLoanTracker_publicKey', publicKey);
            localStorage.setItem('ttLoanTracker_originalLoan', originalLoanAmount.toString());
            localStorage.setItem('ttLoanTracker_totalPaid', totalPaid.toString());
            localStorage.setItem('ttLoanTracker_lastLoan', lastLoanAmount.toString());
            
            showNotification('Settings saved successfully!', 'success');
        }

        // Clear all data
        function clearAll() {
            if (confirm('Are you sure you want to clear all saved data?')) {
                localStorage.clear();
                document.getElementById('privateKey').value = '';
                document.getElementById('vRPid').value = '';
                document.getElementById('publicKey').value = '';
                document.getElementById('currentServer').textContent = 'Not Set';
                
                document.querySelectorAll('.server-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                privateKey = '';
                vRPid = '';
                publicKey = '';
                currentServer = '';
                originalLoanAmount = 0;
                totalPaid = 0;
                lastLoanAmount = 0;
                
                resetDisplay();
                stopAutoRefresh();
                
                showNotification('All data cleared successfully!', 'success');
            }
        }

        // Connect to API
        async function connectToAPI() {
            privateKey = document.getElementById('privateKey').value.trim();
            vRPid = document.getElementById('vRPid').value.trim();
            publicKey = document.getElementById('publicKey').value.trim();
            
            if (!privateKey) {
                showNotification('Please enter your private API key', 'error');
                return;
            }
            
            if (!vRPid) {
                showNotification('Please enter your vRP ID', 'error');
                return;
            }
            
            if (!currentServer) {
                showNotification('Please select a server', 'error');
                return;
            }
            
            // Show loading state
            connectBtn.disabled = true;
            connectBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Connecting...';
            apiStatus.classList.remove('hidden');
            apiStatusText.textContent = 'Connecting to API...';
            
            // First, check if we have API charges
            try {
                const charges = await checkAPICharges();
                if (charges === null) {
                    showNotification('Failed to connect to API. Check your key and server.', 'error');
                    resetConnectButton();
                    return;
                }
                
                if (charges <= 0) {
                    showNotification('No API charges remaining. Refill with /api private refill', 'error');
                    resetConnectButton();
                    return;
                }
                
                // Update charges display
                document.getElementById('apiCharges').textContent = charges;
                
                // Now fetch loan data
                await fetchLoanData();
                
                // Start auto-refresh
                startAutoRefresh();
                
                // Update status
                statusDot.className = 'status-dot connected';
                statusText.textContent = 'Connected';
                statusIndicator.style.background = 'rgba(46, 204, 113, 0.1)';
                
                showNotification('Successfully connected to API!', 'success');
            } catch (error) {
                console.error('Connection error:', error);
                showNotification('Error connecting to API: ' + error.message, 'error');
                statusDot.className = 'status-dot disconnected';
                statusText.textContent = 'Connection Failed';
                statusIndicator.style.background = 'rgba(231, 76, 60, 0.1)';
            } finally {
                resetConnectButton();
            }
        }

        // Check API charges
        async function checkAPICharges() {
            try {
                const response = await fetch(currentServer + 'status/charges.json', {
                    headers: {
                        'X-Tycoon-Key': privateKey
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                return data[0]; // Charges are returned as an array with one element
            } catch (error) {
                console.error('Error checking API charges:', error);
                return null;
            }
        }

        // Fetch loan data
        async function fetchLoanData() {
            try {
                apiStatusText.textContent = 'Fetching loan data...';
                
                const headers = {
                    'X-Tycoon-Key': privateKey
                };
                
                if (publicKey) {
                    headers['X-Tycoon-Public-Key'] = publicKey;
                }
                
                const response = await fetch(`${currentServer}status/wealth/${vRPid}`, {
                    headers: headers
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Check if player is online (wealth endpoint requires player to be online)
                if (data.code !== "200") {
                    throw new Error('Player must be online to fetch wealth data');
                }
                
                // Update loan data
                const currentLoan = data.loan || 0;
                const wallet = data.wallet || 0;
                const bank = data.bank || 0;
                
                // Update display
                updateLoanDisplay(currentLoan, wallet, bank);
                
                // Update last updated time
                document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();
                document.getElementById('playerStatus').textContent = 'Online';
                
                // Update API charges from response header
                const chargesHeader = response.headers.get('X-Tycoon-Charges');
                if (chargesHeader) {
                    document.getElementById('apiCharges').textContent = chargesHeader;
                }
                
                apiStatusText.textContent = 'Data fetched successfully!';
                setTimeout(() => {
                    apiStatus.classList.add('hidden');
                }, 2000);
                
                return true;
            } catch (error) {
                console.error('Error fetching loan data:', error);
                apiStatusText.textContent = `Error: ${error.message}`;
                document.getElementById('playerStatus').textContent = 'Offline/Error';
                
                // Keep status visible on error
                setTimeout(() => {
                    apiStatus.classList.add('hidden');
                }, 5000);
                
                return false;
            }
        }

        // Update loan display
        function updateLoanDisplay(currentLoan, wallet, bank) {
            // Format currency
            const formatter = new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            });
            
            // Update loan balance
            document.getElementById('loanBalance').textContent = formatter.format(currentLoan);
            
            // If this is the first time we see a loan, set it as original amount
            if (originalLoanAmount === 0 && currentLoan > 0) {
                originalLoanAmount = currentLoan;
                localStorage.setItem('ttLoanTracker_originalLoan', originalLoanAmount.toString());
            }
            
            // If we have a previous loan amount, calculate payment
            if (lastLoanAmount > 0 && currentLoan < lastLoanAmount) {
                const payment = lastLoanAmount - currentLoan;
                totalPaid += payment;
                localStorage.setItem('ttLoanTracker_totalPaid', totalPaid.toString());
                
                // Show notification for payment
                showNotification(`Payment detected: ${formatter.format(payment)}`, 'success');
            }
            
            // Update last loan amount
            lastLoanAmount = currentLoan;
            localStorage.setItem('ttLoanTracker_lastLoan', lastLoanAmount.toString());
            
            // Update total paid display
            updateTotalPaidDisplay();
            
            // Calculate remaining (original loan - total paid)
            const remaining = Math.max(0, originalLoanAmount - totalPaid);
            document.getElementById('remainingBalance').textContent = formatter.format(originalLoanAmount);
            
            // Calculate progress percentage
            let progress = 0;
            if (originalLoanAmount > 0) {
                progress = Math.min(100, (totalPaid / originalLoanAmount) * 100);
            }
            
            // Update progress bar
            const progressFill = document.getElementById('progressFill');
            progressFill.style.width = `${progress}%`;
            document.getElementById('progressPercentage').textContent = `${progress.toFixed(1)}%`;
            
            // Update progress bar color based on progress
            progressFill.className = 'progress-fill';
            if (progress < 30) {
                progressFill.classList.add('low');
            } else if (progress < 70) {
                progressFill.classList.add('medium');
            }
            
            // Update additional details
            document.getElementById('loanDetails').innerHTML = `
                <div class="detail-item">
                    <div class="detail-label">Last Updated</div>
                    <div class="detail-value">${new Date().toLocaleTimeString()}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Wallet Balance</div>
                    <div class="detail-value">${formatter.format(wallet)}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Bank Balance</div>
                    <div class="detail-value">${formatter.format(bank)}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Player Status</div>
                    <div class="detail-value" style="color: var(--success-color);">Online</div>
                </div>
            `;
        }

        // Update total paid display
        function updateTotalPaidDisplay() {
            const formatter = new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            });
            document.getElementById('totalPaid').textContent = formatter.format(totalPaid);
        }

        // Reset display
        function resetDisplay() {
            document.getElementById('loanBalance').textContent = '$0';
            document.getElementById('totalPaid').textContent = '$0';
            document.getElementById('remainingBalance').textContent = '$0';
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('progressPercentage').textContent = '0%';
            document.getElementById('lastUpdated').textContent = 'Never';
            document.getElementById('apiCharges').textContent = '0';
            document.getElementById('playerStatus').textContent = 'Offline';
            
            statusDot.className = 'status-dot disconnected';
            statusText.textContent = 'Not Connected';
            statusIndicator.style.background = '';
        }

        // Start auto-refresh
        function startAutoRefresh() {
            if (apiInterval) {
                clearInterval(apiInterval);
            }
            
            apiInterval = setInterval(() => {
                fetchLoanData();
            }, 60000); // Refresh every 60 seconds
        }

        // Stop auto-refresh
        function stopAutoRefresh() {
            if (apiInterval) {
                clearInterval(apiInterval);
                apiInterval = null;
            }
        }

        // Reset connect button
        function resetConnectButton() {
            connectBtn.disabled = false;
            connectBtn.innerHTML = '<i class="fas fa-plug"></i> Connect to API';
        }

        // Show notification
        function showNotification(message, type) {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                background: ${type === 'success' ? 'var(--success-color)' : 'var(--danger-color)'};
                color: white;
                border-radius: 8px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;
            
            notification.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
                ${message}
            `;
            
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // Add CSS for notifications
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        // Event Listeners
        connectBtn.addEventListener('click', connectToAPI);
        refreshBtn.addEventListener('click', () => {
            if (privateKey && vRPid && currentServer) {
                fetchLoanData();
            } else {
                showNotification('Please connect first', 'error');
            }
        });
        saveBtn.addEventListener('click', saveSettings);
        clearBtn.addEventListener('click', clearAll);

        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            initServerSelector();
            loadSettings();
        });

        // Save settings on page unload
        window.addEventListener('beforeunload', saveSettings);
    </script>
</body>
</html>
